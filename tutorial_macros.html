


<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="ja">
  <head>
    <meta charset="utf-8" />
    <title>Tutorial: Macros &#8212; xonsh 0.9.0 ドキュメント</title>
    <link rel="stylesheet" href="_static/numpy_friendly.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/graphviz.css" />
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Noticia+Text|Open+Sans|Droid+Sans+Mono" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    <script type="text/javascript" src="_static/translations.js"></script>
    <script type="text/javascript" src="_static/jquery.cookie.js"></script>
    <script type="text/javascript" src="_static/cloud.base.js"></script>
    <script type="text/javascript" src="_static/cloud.js"></script>
    <link rel="shortcut icon" href="_static/magic_conch.ico"/>
    <link rel="index" title="索引" href="genindex.html" />
    <link rel="search" title="検索" href="search.html" />
    <link rel="next" title="Tutorial: Extensions (Xontribs)" href="tutorial_xontrib.html" />
    <link rel="prev" title="Tutorial: History" href="tutorial_hist.html" />
     
        <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="canonical" href="http://xon.sh/tutorial_macros.html"/>

  </head><body>
    <div class="relbar-top">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>ナビゲーション</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="総合索引"
             accesskey="I">索引</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Pythonモジュール索引"
             >モジュール</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="tutorial_xontrib.html" title="Tutorial: Extensions (Xontribs)"
             accesskey="N">次へ</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="tutorial_hist.html" title="Tutorial: History"
             accesskey="P">前へ</a> &nbsp; &nbsp;</li>
    <li><a href="sidebar.html">xonsh 0.9.0 ドキュメント</a> &#187;</li>

          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Xonsh シェル</a> &#187;</li> 
      </ul>
    </div>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="tutorial-macros">
<span id="id1"></span><h1>Tutorial: Macros<a class="headerlink" href="#tutorial-macros" title="このヘッドラインへのパーマリンク">¶</a></h1>
<p>Bust out your DSLRs, people. It is time to closely examine macros!</p>
<div class="section" id="what-are-macro-instructions">
<h2>What are macro instructions?<a class="headerlink" href="#what-are-macro-instructions" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>In generic terms, a programming macro is a special kind of syntax that
replaces a smaller amount of code with a larger expression, syntax tree,
code object, etc after the macro has been evaluated.
In practice, macros pause the normal parsing and evaluation of the code
that they contain. This is so that they can perform their expansion with
a complete inputs. Roughly, the algorithm executing a macro follows is:</p>
<ol class="arabic simple">
<li><p>Macro start, pause or skip normal parsing</p></li>
<li><p>Gather macro inputs as strings</p></li>
<li><p>Evaluate macro with inputs</p></li>
<li><p>Resume normal parsing and execution.</p></li>
</ol>
<p>Is this meta-programming? You betcha!</p>
</div>
<div class="section" id="when-and-where-are-macros-used">
<h2>When and where are macros used?<a class="headerlink" href="#when-and-where-are-macros-used" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>Macros are a practicality-beats-purity feature of many programing
languages. Because they allow you break out of the normal parsing
cycle, depending on the language, you can do some truly wild things with
them. However, macros are really there to reduce the amount of boiler plate
code that users and developers have to write.</p>
<p>In C and C++ (and Fortran), the C Preprocessor <code class="docutils literal notranslate"><span class="pre">cpp</span></code> is a macro evaluation
engine. For example, every time you see an <code class="docutils literal notranslate"><span class="pre">#include</span></code> or <code class="docutils literal notranslate"><span class="pre">#ifdef</span></code>, this is
the <code class="docutils literal notranslate"><span class="pre">cpp</span></code> macro system in action.
In these languages, the macros are technically outside of the definition
of the language at hand. Furthermore, because <code class="docutils literal notranslate"><span class="pre">cpp</span></code> must function with only
a single pass through the code, the sorts of macros that can be written with
<code class="docutils literal notranslate"><span class="pre">cpp</span></code> are relatively simple.</p>
<p>Rust, on the other hand, has a first-class notion of macros that look and
feel a lot like normal functions. Macros in Rust are capable of pulling off
type information from their arguments and preventing their return values
from being consumed.</p>
<p>Other languages like Lisp, Forth, and Julia also provide their macro systems.
Even restructured text (rST) directives could be considered macros.
Haskell and other more purely functional languages do not need macros (since
evaluation is lazy anyway), and so do not have them.</p>
<p>If these seem unfamiliar to the Python world, note that Jupyter and IPython
magics <code class="docutils literal notranslate"><span class="pre">%</span></code> and <code class="docutils literal notranslate"><span class="pre">%%</span></code> are macros!</p>
</div>
<div class="section" id="function-macros">
<h2>Function Macros<a class="headerlink" href="#function-macros" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>Xonsh supports Rust-like macros that are based on normal Python callables.
Macros do not require a special definition in xonsh. However, like in Rust,
they must be called with an exclamation point <code class="docutils literal notranslate"><span class="pre">!</span></code> between the callable
and the opening parentheses <code class="docutils literal notranslate"><span class="pre">(</span></code>. Macro arguments are split on the top-level
commas <code class="docutils literal notranslate"><span class="pre">,</span></code>, like normal Python functions.  For example, say we have the
functions <code class="docutils literal notranslate"><span class="pre">f</span></code> and <code class="docutils literal notranslate"><span class="pre">g</span></code>. We could perform a macro call on these functions
with the following:</p>
<div class="highlight-xonsh notranslate"><div class="highlight"><pre><span></span><span class="c1"># No macro args</span>
<span class="n">f</span><span class="k">!</span><span class="p">()</span>

<span class="c1"># Single arg</span>
<span class="n">f</span><span class="k">!</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">g</span><span class="k">!</span><span class="p">([</span><span class="n">y</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mi">44</span><span class="p">])</span>

<span class="c1"># Two args</span>
<span class="n">f</span><span class="k">!</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">42</span><span class="p">)</span>
<span class="n">g</span><span class="k">!</span><span class="p">([</span><span class="n">y</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mi">44</span><span class="p">],</span> <span class="n">f</span><span class="k">!</span><span class="p">(</span><span class="n">z</span><span class="p">))</span>
</pre></div>
</div>
<p>Not so bad, right?  So what actually happens to the arguments when used
in a macro call?  Well, that depends on the definition of the function. In
particular, each argument in the macro call is matched up with the corresponding
parameter annotation in the callable's signature.  For example, say we have
an <code class="docutils literal notranslate"><span class="pre">identity()</span></code> function that annotates its sole argument as a string:</p>
<div class="highlight-xonsh notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">identity</span><span class="p">(</span><span class="n">x</span> <span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span>
</pre></div>
</div>
<p>If we call this normally, we'll just get whatever object we put in back out,
even if that object is not a string:</p>
<div class="highlight-xonshcon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">identity</span><span class="p">(</span><span class="s1">&#39;me&#39;</span><span class="p">)</span><span class="go"></span>
<span class="go">&#39;me&#39;</span>

<span class="gp">&gt;&gt;&gt;</span> <span class="n">identity</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span><span class="go"></span>
<span class="go">42</span>

<span class="gp">&gt;&gt;&gt;</span> <span class="n">identity</span><span class="p">(</span><span class="n">identity</span><span class="p">)</span><span class="go"></span>
<span class="go">&lt;function __main__.identity&gt;</span>
</pre></div>
</div>
<p>However, if we perform macro calls instead we are now guaranteed to get
the string of the source code that is in the macro call:</p>
<div class="highlight-xonshcon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">identity</span><span class="k">!</span><span class="p">(</span><span class="s1">&#39;me&#39;</span><span class="p">)</span><span class="go"></span>
<span class="go">&quot;&#39;me&#39;&quot;</span>

<span class="gp">&gt;&gt;&gt;</span> <span class="n">identity</span><span class="k">!</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span><span class="go"></span>
<span class="go">&#39;42&#39;</span>

<span class="gp">&gt;&gt;&gt;</span> <span class="n">identity</span><span class="k">!</span><span class="p">(</span><span class="n">identity</span><span class="p">)</span><span class="go"></span>
<span class="go">&#39;identity&#39;</span>
</pre></div>
</div>
<p>Also note that each macro argument is stripped prior to passing it to the
macro itself. This is done for consistency.</p>
<div class="highlight-xonshcon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">identity</span><span class="k">!</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span><span class="go"></span>
<span class="go">&#39;42&#39;</span>

<span class="gp">&gt;&gt;&gt;</span> <span class="n">identity</span><span class="k">!</span><span class="p">(</span>  <span class="mi">42</span> <span class="p">)</span><span class="go"></span>
<span class="go">&#39;42&#39;</span>
</pre></div>
</div>
<p>Importantly, because we are capturing and not evaluating the source code,
a macro call can contain input that is beyond the usual syntax. In fact, that
is sort of the whole point. Here are some cases to start your gears turning:</p>
<div class="highlight-xonshcon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">identity</span><span class="k">!</span><span class="p">(</span><span class="kn">import</span> <span class="nn">os</span><span class="p">)</span><span class="go"></span>
<span class="go">&#39;import os&#39;</span>

<span class="gp">&gt;&gt;&gt;</span> <span class="n">identity</span><span class="k">!</span><span class="p">(</span><span class="k">if</span> <span class="bp">True</span><span class="p">:</span><span class="gp"></span>
<span class="gp">&gt;&gt;&gt;</span>     <span class="k">pass</span><span class="p">)</span><span class="go"></span>
<span class="go">&#39;if True:\n    pass&#39;</span>

<span class="gp">&gt;&gt;&gt;</span> <span class="n">identity</span><span class="k">!</span><span class="p">(</span><span class="n">std</span><span class="p">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="p">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">x</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;yoo&quot;</span><span class="p">,</span> <span class="s2">&quot;hoo&quot;</span><span class="p">})</span><span class="go"></span>
<span class="go">&#39;std::vector&lt;std::string&gt; x = {&quot;yoo&quot;, &quot;hoo&quot;}&#39;</span>
</pre></div>
</div>
<p>You do you, <code class="docutils literal notranslate"><span class="pre">identity()</span></code>.</p>
</div>
<div class="section" id="calling-function-macros">
<h2>Calling Function Macros<a class="headerlink" href="#calling-function-macros" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>There are a couple of points to consider when calling macros. The first is
that passing in arguments by name will not behave as expected. This is because
the <code class="docutils literal notranslate"><span class="pre">&lt;name&gt;=</span></code> is captured by the macro itself. Using the <code class="docutils literal notranslate"><span class="pre">identity()</span></code>
function from above:</p>
<div class="highlight-xonshcon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">identity</span><span class="k">!</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span><span class="go"></span>
<span class="go">&#39;x=42&#39;</span>
</pre></div>
</div>
<p>Performing a macro call uses only argument order to pass in values.</p>
<p>Additionally, macro calls split arguments only on the top-level commas.
The top-level commas are not included in any argument.
This behaves analogously to normal Python function calls. For instance,
say we have the following <code class="docutils literal notranslate"><span class="pre">g()</span></code> function that accepts two arguments:</p>
<div class="highlight-xonsh notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">g</span><span class="p">(</span><span class="n">x</span> <span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">y</span> <span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;x = &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;y = &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
</pre></div>
</div>
<p>Then you can see the splitting and stripping behavior on each macro
argument:</p>
<div class="highlight-xonshcon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">g</span><span class="k">!</span><span class="p">(</span><span class="mi">42</span><span class="p">,</span> <span class="mi">65</span><span class="p">)</span><span class="go"></span>
<span class="go">x = &#39;42&#39;</span>
<span class="go">y = &#39;65&#39;</span>

<span class="gp">&gt;&gt;&gt;</span> <span class="n">g</span><span class="k">!</span><span class="p">(</span><span class="mi">42</span><span class="p">,</span> <span class="mi">65</span><span class="p">,)</span><span class="go"></span>
<span class="go">x = &#39;42&#39;</span>
<span class="go">y = &#39;65&#39;</span>

<span class="gp">&gt;&gt;&gt;</span> <span class="n">g</span><span class="k">!</span><span class="p">(</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">65</span><span class="p">,</span> <span class="p">)</span><span class="go"></span>
<span class="go">x = &#39;42&#39;</span>
<span class="go">y = &#39;65&#39;</span>

<span class="gp">&gt;&gt;&gt;</span> <span class="n">g</span><span class="k">!</span><span class="p">([</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">],</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mi">3</span><span class="p">})</span><span class="go"></span>
<span class="go">x = &quot;[&#39;x&#39;, &#39;y&#39;]&quot;</span>
<span class="go">y = &#39;{1: 1, 2: 3}&#39;</span>
</pre></div>
</div>
<p>Sometimes you may only want to pass in the first few arguments as macro
arguments and you want the rest to be treated as normal Python arguments.
By convention, xonsh's macro caller will look for a lone <code class="docutils literal notranslate"><span class="pre">*</span></code> argument
in order to split the macro arguments and the regular arguments. So for
example:</p>
<div class="highlight-xonshcon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">g</span><span class="k">!</span><span class="p">(</span><span class="mi">42</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="mi">65</span><span class="p">)</span><span class="go"></span>
<span class="go">x = &#39;42&#39;</span>
<span class="go">y = 65</span>

<span class="gp">&gt;&gt;&gt;</span> <span class="n">g</span><span class="k">!</span><span class="p">(</span><span class="mi">42</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">65</span><span class="p">)</span><span class="go"></span>
<span class="go">x = &#39;42&#39;</span>
<span class="go">y = 65</span>
</pre></div>
</div>
<p>In the above, note that <code class="docutils literal notranslate"><span class="pre">x</span></code> is still captured as a macro argument. However,
everything after the <code class="docutils literal notranslate"><span class="pre">*</span></code>, namely <code class="docutils literal notranslate"><span class="pre">y</span></code>, is evaluated is if it were passed
in to a normal function call.  This can be useful for large interfaces where
only a handful of args are expected as macro arguments.</p>
<p>Hopefully, now you see the big picture.</p>
</div>
<div class="section" id="writing-function-macros">
<h2>Writing Function Macros<a class="headerlink" href="#writing-function-macros" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>Though any function (or callable) can be used as a macro, this functionality
is probably most useful if the function was <em>designed</em> as a macro. There
are two main aspects of macro design to consider: argument annotations and
call site execution context.</p>
<div class="section" id="macro-annotations">
<h3>Macro Annotations<a class="headerlink" href="#macro-annotations" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>There are six kinds of annotations that macros are able to interpret:</p>
<table class="docutils align-center" id="id2">
<caption><span class="caption-text">Kinds of Annotation</span><a class="headerlink" href="#id2" title="このテーブルへのパーマリンク">¶</a></caption>
<colgroup>
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Category</p></th>
<th class="head"><p>Object</p></th>
<th class="head"><p>Flags</p></th>
<th class="head"><p>Modes</p></th>
<th class="head"><p>Returns</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>String</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">str</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">'s'</span></code>, <code class="docutils literal notranslate"><span class="pre">'str'</span></code>, or <code class="docutils literal notranslate"><span class="pre">'string'</span></code></p></td>
<td></td>
<td><p>Source code of argument as string, <em>default</em>.</p></td>
</tr>
<tr class="row-odd"><td><p>AST</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">ast.AST</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">'a'</span></code> or <code class="docutils literal notranslate"><span class="pre">'ast'</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">'eval'</span></code> (default), <code class="docutils literal notranslate"><span class="pre">'exec'</span></code>, or <code class="docutils literal notranslate"><span class="pre">'single'</span></code></p></td>
<td><p>Abstract syntax tree of argument.</p></td>
</tr>
<tr class="row-even"><td><p>Code</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">types.CodeType</span></code> or <code class="docutils literal notranslate"><span class="pre">compile</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">'c'</span></code>, <code class="docutils literal notranslate"><span class="pre">'code'</span></code>, or <code class="docutils literal notranslate"><span class="pre">'compile'</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">'eval'</span></code> (default), <code class="docutils literal notranslate"><span class="pre">'exec'</span></code>, or <code class="docutils literal notranslate"><span class="pre">'single'</span></code></p></td>
<td><p>Compiled code object of argument.</p></td>
</tr>
<tr class="row-odd"><td><p>Eval</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">eval</span></code> or <code class="docutils literal notranslate"><span class="pre">None</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">'v'</span></code> or <code class="docutils literal notranslate"><span class="pre">'eval'</span></code></p></td>
<td></td>
<td><p>Evaluation of the argument.</p></td>
</tr>
<tr class="row-even"><td><p>Exec</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">exec</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">'x'</span></code> or <code class="docutils literal notranslate"><span class="pre">'exec'</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">'exec'</span></code> (default) or <code class="docutils literal notranslate"><span class="pre">'single'</span></code></p></td>
<td><p>Execs the argument and returns None.</p></td>
</tr>
<tr class="row-odd"><td><p>Type</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">type</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">'t'</span></code> or <code class="docutils literal notranslate"><span class="pre">'type'</span></code></p></td>
<td></td>
<td><p>The type of the argument after it has been evaluated.</p></td>
</tr>
</tbody>
</table>
<p>These annotations allow you to hook into whichever stage of the compilation
that you desire. It is important to note that the string form of the arguments
is split and stripped (as described above) prior to conversion to the
annotation type.</p>
<p>Each argument may be annotated with its own individual type. Annotations
may be provided as either objects or as the string flags seen in the above
table. String flags are case-insensitive.
If an argument does not have an annotation, <code class="docutils literal notranslate"><span class="pre">str</span></code> is selected.
This makes the macro function call behave like the subprocess macros and
context manager macros below. For example,</p>
<div class="highlight-xonsh notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="p">:</span> <span class="s1">&#39;AST&#39;</span><span class="p">,</span> <span class="n">c</span> <span class="p">:</span> <span class="nb">compile</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div>
</div>
<p>In a macro call of <code class="docutils literal notranslate"><span class="pre">func!()</span></code>,</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">a</span></code> will be evaluated with <code class="docutils literal notranslate"><span class="pre">str</span></code> since no annotation was provided,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">b</span></code> will be parsed into a syntax tree node, and</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">c</span></code> will be compiled into code object since the builtin <code class="docutils literal notranslate"><span class="pre">compile()</span></code>
function was used as the annotation.</p></li>
</ul>
<p>Additionally, certain kinds of annotations have different modes that
affect the parsing, compilation, and execution of its argument.  While a
sensible default is provided, you may also supply your own. This is
done by annotating with a (kind, mode) tuple.  The first element can
be any valid object or flag. The second element must be a corresponding
mode as a string.  For instance,</p>
<div class="highlight-xonsh notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">gunc</span><span class="p">(</span><span class="n">d</span> <span class="p">:</span> <span class="p">(</span><span class="k">exec</span><span class="p">,</span> <span class="s1">&#39;single&#39;</span><span class="p">),</span> <span class="n">e</span> <span class="p">:</span> <span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;exec&#39;</span><span class="p">)):</span>
    <span class="k">pass</span>
</pre></div>
</div>
<p>Thus in a macro call of <code class="docutils literal notranslate"><span class="pre">gunc!()</span></code>,</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">d</span></code> will be exec'd in single-mode (rather than exec-mode), and</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">e</span></code> will be compiled in exec-mode (rather than eval-mode).</p></li>
</ul>
<p>For more information on the differences between the exec, eval, and single
modes please see the Python documentation.</p>
</div>
<div class="section" id="macro-function-execution-context">
<h3>Macro Function Execution Context<a class="headerlink" href="#macro-function-execution-context" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>Equally important as having the macro arguments is knowing the execution
context of the macro call itself. Rather than mucking around with frames,
macros provide both the globals and locals of the call site.  These are
accessible as the <code class="docutils literal notranslate"><span class="pre">macro_globals</span></code> and <code class="docutils literal notranslate"><span class="pre">macro_locals</span></code> attributes of
the macro function itself while the macro is being executed.</p>
<p>For example, consider a macro which replaces all literal <code class="docutils literal notranslate"><span class="pre">1</span></code> digits
with the literal <code class="docutils literal notranslate"><span class="pre">2</span></code>, evaluates the modification, and returns the results.
To eval, the macro will need to pull off its globals and locals:</p>
<div class="highlight-xonsh notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">one_to_two</span><span class="p">(</span><span class="n">x</span> <span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">)</span>
    <span class="n">glbs</span> <span class="o">=</span> <span class="n">one_to_two</span><span class="o">.</span><span class="n">macro_globals</span>
    <span class="n">locs</span> <span class="o">=</span> <span class="n">one_to_two</span><span class="o">.</span><span class="n">macro_locals</span>
    <span class="k">return</span> <span class="nb">eval</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">glbs</span><span class="p">,</span> <span class="n">locs</span><span class="p">)</span>
</pre></div>
</div>
<p>Running this with a few of different inputs, we see:</p>
<div class="highlight-xonshcon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">one_to_two</span><span class="k">!</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="go"></span>
<span class="go">4</span>

<span class="gp">&gt;&gt;&gt;</span> <span class="n">one_to_two</span><span class="k">!</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="go"></span>
<span class="go">22</span>

<span class="gp">&gt;&gt;&gt;</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">1</span><span class="gp"></span>
<span class="gp">&gt;&gt;&gt;</span> <span class="n">one_to_two</span><span class="k">!</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="go"></span>
<span class="go">3</span>
</pre></div>
</div>
<p>Of course, many other more sophisticated options are available depending on the
use case.</p>
</div>
</div>
<div class="section" id="subprocess-macros">
<h2>Subprocess Macros<a class="headerlink" href="#subprocess-macros" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>Like with function macros above, subprocess macros allow you to pause the parser
for until you are ready to exit subprocess mode. Unlike function macros, there
is only a single macro argument and its macro type is always a string.  This
is because it (usually) doesn't make sense to pass non-string arguments to a
command. And when it does, there is the <code class="docutils literal notranslate"><span class="pre">&#64;()</span></code> syntax!</p>
<p>In the simplest case, subprocess macros look like the equivalent of their
function macro counterparts:</p>
<div class="highlight-xonshcon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">echo</span><span class="k">!</span> <span class="n">I</span><span class="s1">&#39;m Mr. Meeseeks.</span>
<span class="n">I</span><span class="s1">&#39;m Mr. Meeseeks.</span>
</pre></div>
</div>
<p>Again, note that everything to the right of the <code class="docutils literal notranslate"><span class="pre">!</span></code> is passed down to the
<code class="docutils literal notranslate"><span class="pre">echo</span></code> command as the final, single argument. This is space preserving,
like wrapping with quotes:</p>
<div class="highlight-xonshcon notranslate"><div class="highlight"><pre><span></span><span class="c1"># normally, xonsh will split on whitespace,</span><span class="go"></span>
<span class="go"># so each argument is passed in separately</span><span class="gp"></span>
<span class="gp">&gt;&gt;&gt;</span> <span class="n">echo</span> <span class="n">x</span>  <span class="n">y</span>       <span class="n">z</span><span class="go"></span>
<span class="go">x y z</span>

<span class="go"># usually space can be preserved with quotes</span><span class="gp"></span>
<span class="gp">&gt;&gt;&gt;</span> <span class="n">echo</span> <span class="s2">&quot;x  y       z&quot;</span><span class="go"></span>
<span class="go">x  y       z</span>

<span class="go"># however, subprocess macros will pause and then strip</span>
<span class="go"># all input after the exclamation point</span><span class="gp"></span>
<span class="gp">&gt;&gt;&gt;</span> <span class="n">echo</span><span class="k">!</span> <span class="n">x</span>  <span class="n">y</span>       <span class="n">z</span><span class="go"></span>
<span class="go">x  y       z</span>
</pre></div>
</div>
<p>However, the macro will pause everything, including path and environment variable
expansion, that might be present even with quotes.  For example:</p>
<div class="highlight-xonshcon notranslate"><div class="highlight"><pre><span></span><span class="c1"># without macros, environment variable are expanded</span><span class="gp"></span>
<span class="gp">&gt;&gt;&gt;</span> <span class="n">echo</span> <span class="nv">$USER</span><span class="go"></span>
<span class="go">lou</span>

<span class="go"># inside of a macro, all additional munging is turned off.</span><span class="gp"></span>
<span class="gp">&gt;&gt;&gt;</span> <span class="n">echo</span><span class="k">!</span> <span class="nv">$USER</span><span class="go"></span>
<span class="go">$USER</span>
</pre></div>
</div>
<p>Everything to the right of the exclamation point, except the leading and trailing
whitespace, is passed into the command directly as written. This allows certain
commands to function in cases where quoting or piping might be more burdensome.
The <code class="docutils literal notranslate"><span class="pre">timeit</span></code> command is a great example where simple syntax will often fail,
but will be easily executable as a macro:</p>
<div class="highlight-xonshcon notranslate"><div class="highlight"><pre><span></span><span class="c1"># fails normally</span><span class="gp"></span>
<span class="gp">&gt;&gt;&gt;</span> <span class="n">timeit</span> <span class="s2">&quot;hello mom &quot;</span> <span class="o">+</span> <span class="s2">&quot;and dad&quot;</span><span class="go"></span>
<span class="go">xonsh: subprocess mode: command not found: hello</span>

<span class="go"># macro success!</span><span class="gp"></span>
<span class="gp">&gt;&gt;&gt;</span> <span class="n">timeit</span><span class="k">!</span> <span class="s2">&quot;hello mom &quot;</span> <span class="o">+</span> <span class="s2">&quot;and dad&quot;</span><span class="go"></span>
<span class="go">100000000 loops, best of 3: 8.24 ns per loop</span>
</pre></div>
</div>
<p>All expressions to the left of the exclamation point are passed in normally and
are not treated as the special macro argument. This allows the mixing of
simple and complex command line arguments. For example, sometimes you might
really want to write some code in another language:</p>
<div class="highlight-xonshcon notranslate"><div class="highlight"><pre><span></span><span class="c1"># don&#39;t worry, it is temporary!</span><span class="gp"></span>
<span class="gp">&gt;&gt;&gt;</span> <span class="n">bash</span> <span class="o">-</span><span class="n">c</span> <span class="err">!</span> <span class="n">export</span> <span class="n">var</span><span class="o">=</span><span class="mi">42</span><span class="p">;</span> <span class="n">echo</span> <span class="nv">$var</span><span class="go"></span>
<span class="go">42</span>

<span class="go"># that&#39;s better!</span><span class="gp"></span>
<span class="gp">&gt;&gt;&gt;</span> <span class="n">python</span> <span class="o">-</span><span class="n">c</span> <span class="err">!</span> <span class="kn">import</span> <span class="nn">os</span><span class="p">;</span> <span class="k">print</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">))</span><span class="go"></span>
<span class="go">/</span>
</pre></div>
</div>
<p>Compared to function macros, subprocess macros are relatively simple.
However, they can still be very expressive!</p>
</div>
<div class="section" id="context-manager-macros">
<h2>Context Manager Macros<a class="headerlink" href="#context-manager-macros" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>Now that we have seen what life can be like with macro expressions, it is time
to introduce the macro statement: <code class="docutils literal notranslate"><span class="pre">with!</span></code>.  With-bang provides macros
on top of existing Python context managers. This provides both anonymous
and onymous blocks in xonsh.</p>
<p>The syntax for context manager macros is the same as the usual with-statement
in Python, but with an additional exclamation point between the <code class="docutils literal notranslate"><span class="pre">with</span></code> word
and the first context manager expression. As a simple example,</p>
<div class="highlight-xonsh notranslate"><div class="highlight"><pre><span></span><span class="k">with!</span> <span class="n">x</span><span class="p">:</span>
    <span class="n">y</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="k">print</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
<p>In the above, everything to the left of the colon (<code class="docutils literal notranslate"><span class="pre">x</span></code>) will be evaluated
normally. However, the body will not be executed and <code class="docutils literal notranslate"><span class="pre">y</span></code> will not be defined
or printed. In this case, the body will be attached to x as a string, along with
globals and locals, prior to the body even being entered. The body is then
replaced with a <code class="docutils literal notranslate"><span class="pre">pass</span></code> statement. You can think of the above as being
transformed into the following:</p>
<div class="highlight-xonsh notranslate"><div class="highlight"><pre><span></span><span class="n">x</span><span class="o">.</span><span class="n">macro_block</span> <span class="o">=</span> <span class="s1">&#39;y = 10</span><span class="se">\n</span><span class="s1">print(y)</span><span class="se">\n</span><span class="s1">&#39;</span>
<span class="n">x</span><span class="o">.</span><span class="n">macro_globals</span> <span class="o">=</span> <span class="nb">globals</span><span class="p">()</span>
<span class="n">x</span><span class="o">.</span><span class="n">macro_locals</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">()</span>
<span class="k">with!</span> <span class="n">x</span><span class="p">:</span>
    <span class="k">pass</span>
</pre></div>
</div>
<p>There are a few important things about this to notice:</p>
<ol class="arabic simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">macro_block</span></code> string is dedented,</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">macro_*</span></code> attributes are set <em>before</em> the context manager is entered so
the <code class="docutils literal notranslate"><span class="pre">__enter__()</span></code> method may use them, and</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">macro_*</span></code> attributes are not cleaned up automatically so that the
context manager may use them even after the object is exited. The
<code class="docutils literal notranslate"><span class="pre">__exit__()</span></code> method may clean up these attributes, if desired.</p></li>
</ol>
<p>By default, macro blocks are returned as a string. However, like with function
macro arguments, the kind of <code class="docutils literal notranslate"><span class="pre">macro_block</span></code> is determined by a special
annotation.  This annotation is given via the <code class="docutils literal notranslate"><span class="pre">__xonsh_block__</span></code> attribute
on the context manager itself.  This allows the block to be interpreted as
an AST, byte compiled, etc.</p>
<p>The convenient part about this syntax is that the macro block is only
exited once it sees a dedent back to the level of the <code class="docutils literal notranslate"><span class="pre">with!</span></code>. All other
code is indiscriminately skipped! This allows you to write blocks of code in
languages other than xonsh without pause.</p>
<p>For example, consider a simple
XML macro context manager. This will return the parsed XML tree from a
macro block. The context manager itself can be written as:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xml.etree.ElementTree</span> <span class="kn">as</span> <span class="nn">ET</span>

<span class="k">class</span> <span class="nc">XmlBlock</span><span class="p">:</span>

    <span class="c1"># make sure the macro_block comes back as a string</span>
    <span class="n">__xonsh_block__</span> <span class="o">=</span> <span class="nb">str</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># parse and return the block on entry</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">macro_block</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">root</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">exc</span><span class="p">):</span>
        <span class="c1"># no reason to keep these attributes around.</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">macro_block</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">macro_globals</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">macro_locals</span>
</pre></div>
</div>
<p>The above class may then be used in a with-bang as follows:</p>
<div class="highlight-xonsh notranslate"><div class="highlight"><pre><span></span><span class="k">with!</span> <span class="n">XmlBlock</span><span class="p">()</span> <span class="k">as</span> <span class="n">tree</span><span class="p">:</span>
    <span class="o">&lt;</span><span class="n">note</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">to</span><span class="o">&gt;</span><span class="n">You</span><span class="o">&lt;/</span><span class="n">to</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">from</span><span class="o">&gt;</span><span class="n">Xonsh</span><span class="o">&lt;/</span><span class="n">from</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">heading</span><span class="o">&gt;</span><span class="n">Don</span><span class="s1">&#39;t You Want Me, Baby&lt;/heading&gt;</span>
      <span class="o">&lt;</span><span class="n">body</span><span class="o">&gt;</span>
        <span class="n">You</span> <span class="n">know</span> <span class="n">I</span> <span class="n">don</span><span class="s1">&#39;t believe you when you say that you don&#39;</span><span class="n">t</span> <span class="n">need</span> <span class="n">me</span><span class="o">.</span>
      <span class="o">&lt;/</span><span class="n">body</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="n">note</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>And if you run this, you'll see that the <code class="docutils literal notranslate"><span class="pre">tree</span></code> object really is a parsed
XML object.</p>
<div class="highlight-xonshcon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">print</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span><span class="go"></span>
<span class="go">note</span>
</pre></div>
</div>
<p>So in roughly eight lines of xonsh code, you can seamlessly interface
with another, vastly different language.</p>
<p>The possibilities for this are not limited to just markup languages or other
party tricks. You could be a remote execution interface via SSH, RPC,
dask / distributed, etc. The real benefit of context manager macros is
that they allow you to select when, where, and what code is executed as a
part of the xonsh language itself.</p>
<p>The power is there; use it without reservation!</p>
</div>
<div class="section" id="take-away">
<h2>Take Away<a class="headerlink" href="#take-away" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>Hopefully, at this point, you see that a few well placed macros can be extremely
convenient and valuable to any project.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
        <p class="logo"><a href="sidebar.html" title="sidebar">
          <img class="logo" src="_static/ascii_conch_part_transparent_tight.png" alt="Logo"/>
        </a></p><div class="sphinx-toc sphinxlocaltoc">
    <h3><a href="sidebar.html">Page contents</a></h3>
    <ul>
<li><a class="reference internal" href="#">Tutorial: Macros</a><ul>
<li><a class="reference internal" href="#what-are-macro-instructions">What are macro instructions?</a></li>
<li><a class="reference internal" href="#when-and-where-are-macros-used">When and where are macros used?</a></li>
<li><a class="reference internal" href="#function-macros">Function Macros</a></li>
<li><a class="reference internal" href="#calling-function-macros">Calling Function Macros</a></li>
<li><a class="reference internal" href="#writing-function-macros">Writing Function Macros</a><ul>
<li><a class="reference internal" href="#macro-annotations">Macro Annotations</a></li>
<li><a class="reference internal" href="#macro-function-execution-context">Macro Function Execution Context</a></li>
</ul>
</li>
<li><a class="reference internal" href="#subprocess-macros">Subprocess Macros</a></li>
<li><a class="reference internal" href="#context-manager-macros">Context Manager Macros</a></li>
<li><a class="reference internal" href="#take-away">Take Away</a></li>
</ul>
</li>
</ul>

  </div>
  <div class="sphinxprev">
    <h4>Previous page</h4>
    <p class="topless"><a href="tutorial_hist.html"
                          title="Previous page">&larr; Tutorial: History</a></p>
  </div>
  <div class="sphinxnext">
    <h4>Next page</h4>
    <p class="topless"><a href="tutorial_xontrib.html"
                          title="Next page">&rarr; Tutorial: Extensions (Xontribs)</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>このページ</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/tutorial_macros.rst.txt"
            rel="nofollow">ソースコードを表示</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>クイック検索</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="検索" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
    
    
        <div class="sidebar-toggle-group no-js">
            
            <button class="sidebar-toggle" id="sidebar-hide" title="Hide the sidebar menu">
                 «
                <span class="show-for-small">hide menu</span>
                
            </button>
            <button class="sidebar-toggle" id="sidebar-show" title="Show the sidebar menu">
                
                <span class="show-for-small">menu</span>
                <span class="hide-for-small">sidebar</span>
                 »
            </button>
        </div>
    
      <div class="clearer"></div>
    </div>
    <div class="relbar-bottom">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>ナビゲーション</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="総合索引"
             >索引</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Pythonモジュール索引"
             >モジュール</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="tutorial_xontrib.html" title="Tutorial: Extensions (Xontribs)"
             >次へ</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="tutorial_hist.html" title="Tutorial: History"
             >前へ</a> &nbsp; &nbsp;</li>
    <li><a href="sidebar.html">xonsh 0.9.0 ドキュメント</a> &#187;</li>

          <li class="nav-item nav-item-1"><a href="index.html" >Xonsh シェル</a> &#187;</li> 
      </ul>
    </div>
    </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2015, Anthony Scopatz.
      このドキュメントは <a href="http://sphinx-doc.org/">Sphinx</a> 2.0.1 で生成しました。
    </div>
    <!-- cloud_sptheme 1.4 -->
  </body>
</html>